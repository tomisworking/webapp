name: Prowler Security Audit

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  schedule:
    # Run weekly on Monday at 9:00 AM
    - cron: '0 9 * * 1'
  workflow_dispatch:  # Manual trigger

permissions:
  id-token: write   # Required for OIDC
  contents: read
  security-events: write

env:
  AWS_REGION: us-east-1

jobs:
  prowler-audit:
    name: Prowler AWS Security Audit
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: arn:aws:iam::311603531332:role/GitHubActionsRole
          aws-region: ${{ env.AWS_REGION }}
      
      - name: Install Prowler
        run: |
          pip install prowler
          prowler --version
      
      - name: Run Prowler AWS Security Audit
        run: |
          prowler aws \
            --compliance cis_1.5_aws \
            --output-formats html json csv \
            --output-directory prowler-reports
      
      - name: Upload Prowler Reports
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: prowler-reports
          path: prowler-reports/
          retention-days: 30
      
      - name: Parse Prowler Results
        if: always()
        run: |
          # Parse JSON report for summary
          # Prowler v5 generates files with account ID in name
          JSON_FILE=$(find prowler-reports -name "*.json" -type f | head -1)
          if [ -f "$JSON_FILE" ]; then
            TOTAL=$(jq '[.[] | select(.Status)] | length' "$JSON_FILE")
            PASSED=$(jq '[.[] | select(.Status=="PASS")] | length' "$JSON_FILE")
            FAILED=$(jq '[.[] | select(.Status=="FAIL")] | length' "$JSON_FILE")
            
            if [ $TOTAL -gt 0 ]; then
              COMPLIANCE=$(awk "BEGIN {printf \"%.1f\", ($PASSED/$TOTAL)*100}")
            else
              COMPLIANCE="0.0"
            fi
            
            echo "### üîí Prowler Security Audit Results" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**CIS AWS Foundations Benchmark v1.5.0**" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "| Metric | Value |" >> $GITHUB_STEP_SUMMARY
            echo "|--------|-------|" >> $GITHUB_STEP_SUMMARY
            echo "| ‚úÖ Passed | $PASSED |" >> $GITHUB_STEP_SUMMARY
            echo "| ‚ùå Failed | $FAILED |" >> $GITHUB_STEP_SUMMARY
            echo "| üìä Total Checks | $TOTAL |" >> $GITHUB_STEP_SUMMARY
            echo "| üéØ Compliance | $COMPLIANCE% |" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            
            # List critical failures
            echo "### ‚ö†Ô∏è Critical Findings" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            jq -r '.[] | select(.Status=="FAIL" and .Severity=="critical") | "- **\(.CheckID)**: \(.CheckTitle)"' "$JSON_FILE" | head -10 >> $GITHUB_STEP_SUMMARY || echo "No critical findings" >> $GITHUB_STEP_SUMMARY
          fi
      
      - name: Check Compliance Threshold
        run: |
          JSON_FILE=$(find prowler-reports -name "*.json" -type f | head -1)
          if [ -f "$JSON_FILE" ]; then
            TOTAL=$(jq '[.[] | select(.Status)] | length' "$JSON_FILE")
            PASSED=$(jq '[.[] | select(.Status=="PASS")] | length' "$JSON_FILE")
            
            if [ $TOTAL -gt 0 ]; then
              COMPLIANCE=$(awk "BEGIN {printf \"%.1f\", ($PASSED/$TOTAL)*100}")
              THRESHOLD=80
              
              if (( $(echo "$COMPLIANCE >= $THRESHOLD" | bc -l) )); then
                echo "‚úÖ Compliance ($COMPLIANCE%) meets threshold ($THRESHOLD%)"
              else
                echo "‚ö†Ô∏è Compliance ($COMPLIANCE%) below threshold ($THRESHOLD%)"
                exit 1
              fi
            fi
          fi
      
      - name: Comment PR with Results
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const path = require('path');
            const files = fs.readdirSync('prowler-reports').filter(f => f.endsWith('.json'));
            if (files.length > 0) {
              const jsonFile = path.join('prowler-reports', files[0]);
              const data = JSON.parse(fs.readFileSync(jsonFile));
              const total = data.filter(r => r.Status).length;
              const passed = data.filter(r => r.Status === 'PASS').length;
              const failed = data.filter(r => r.Status === 'FAIL').length;
              const compliance = total > 0 ? ((passed/total)*100).toFixed(1) : 0;
              
              const comment = `## üîí Prowler Security Audit Results
              
              **CIS AWS Foundations Benchmark v1.5.0**
              
              | Metric | Value |
              |--------|-------|
              | ‚úÖ Passed | ${passed} |
              | ‚ùå Failed | ${failed} |
              | üìä Total | ${total} |
              | üéØ Compliance | ${compliance}% |
              
              ${compliance >= 80 ? '‚úÖ Compliance meets threshold (80%)' : '‚ö†Ô∏è Compliance below threshold (80%)'}
              
              [View detailed report in artifacts](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})
              `;
              
              github.rest.issues.createComment({
                issue_number: context.issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: comment
              });
            }
