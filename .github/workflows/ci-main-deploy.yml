name: CI/CD - Main (Testy + Deployment)

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
    types: [ opened, synchronize, closed ]
  merge_group:

env:
  AWS_REGION: eu-central-1
  ECR_REPOSITORY_BACKEND: forum-backend
  S3_BUCKET_FRONTEND: forum-frontend-builds  # Zmie≈Ñ na swojƒÖ nazwƒô bucket je≈õli inna
  ASG_NAME: forum-asg
  LAUNCH_TEMPLATE_NAME: forum-lt

jobs:
  # ============================================
  # TESTY (muszƒÖ przej≈õƒá przed deploymentem)
  # ============================================
  test-backend:
    name: Test Django Backend
    runs-on: ubuntu-latest
    
    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_DB: test_db
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: postgres
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432
    
    steps:
      - name: Pobierz kod
        uses: actions/checkout@v3
      
      - name: Ustaw Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
      
      - name: Zainstaluj zale≈ºno≈õci
        working-directory: ./backend
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
      
      - name: Uruchom migracje
        working-directory: ./backend
        env:
          DATABASE_URL: postgresql://postgres:postgres@localhost:5432/test_db
          SECRET_KEY: test-secret-key-for-ci
          DEBUG: True
          ALLOWED_HOSTS: localhost,127.0.0.1
        run: |
          python manage.py migrate
      
      - name: Sprawd≈∫ kod Django (check)
        working-directory: ./backend
        env:
          DATABASE_URL: postgresql://postgres:postgres@localhost:5432/test_db
          SECRET_KEY: test-secret-key-for-ci
          DEBUG: True
        run: |
          python manage.py check
      
      - name: Sprawd≈∫ kod (flake8)
        working-directory: ./backend
        continue-on-error: true
        run: |
          pip install flake8
          flake8 . --count --select=E9,F63,F7,F82 --show-source --statistics || true
          flake8 . --count --exit-zero --max-complexity=10 --max-line-length=127 --statistics || true
      
      - name: Test Django
        working-directory: ./backend
        env:
          DATABASE_URL: postgresql://postgres:postgres@localhost:5432/test_db
          SECRET_KEY: test-secret-key-for-ci
          DEBUG: True
        continue-on-error: true
        run: |
          python manage.py test || echo "Brak test√≥w - to jest OK"

  test-frontend:
    name: Test React Frontend
    runs-on: ubuntu-latest
    
    steps:
      - name: Pobierz kod
        uses: actions/checkout@v3
      
      - name: Ustaw Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json
      
      - name: Zainstaluj zale≈ºno≈õci
        working-directory: ./frontend
        run: npm ci
      
      - name: Sprawd≈∫ kod (ESLint)
        working-directory: ./frontend
        continue-on-error: true
        run: |
          npm run build || echo "Build check completed"
      
      - name: Buduj aplikacjƒô React (test)
        working-directory: ./frontend
        run: npm run build

  # ============================================
  # BUILD I PUSH DOCKER DO ECR
  # ============================================
  build-and-push-backend:
    name: Build & Push Backend to ECR
    runs-on: ubuntu-latest
    needs: [test-backend, test-frontend]
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    
    steps:
      - name: Pobierz kod
        uses: actions/checkout@v3
      
      - name: Konfiguruj AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}
      
      - name: Logowanie do Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v2
      
      - name: Build, tag i push obraz do ECR
        env:
          ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
          ECR_REPOSITORY: ${{ env.ECR_REPOSITORY_BACKEND }}
          IMAGE_TAG: ${{ github.sha }}
        run: |
          cd backend
          docker build -t $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG .
          docker tag $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG $ECR_REGISTRY/$ECR_REPOSITORY:latest
          docker push $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG
          docker push $ECR_REGISTRY/$ECR_REPOSITORY:latest
          echo "IMAGE_URI=$ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG" >> $GITHUB_ENV
      
      - name: Output image URI
        run: |
          echo "‚úÖ Backend image pushed: ${{ env.IMAGE_URI }}"

  # ============================================
  # BUILD REACT I UPLOAD DO S3
  # ============================================
  build-and-upload-frontend:
    name: Build & Upload Frontend to S3
    runs-on: ubuntu-latest
    needs: [test-backend, test-frontend]
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    
    steps:
      - name: Pobierz kod
        uses: actions/checkout@v3
      
      - name: Konfiguruj AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}
      
      - name: Ustaw Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json
      
      - name: Pobierz ALB DNS z Parameter Store
        id: get-alb-dns
        run: |
          ALB_DNS=$(aws ssm get-parameter --name "/forum/ALB_DNS" --query 'Parameter.Value' --output text 2>/dev/null || echo "kongoapp.pl")
          echo "ALB_DNS=$ALB_DNS" >> $GITHUB_OUTPUT
          echo "Using ALB DNS: $ALB_DNS"
      
      - name: Utw√≥rz .env.production
        working-directory: ./frontend
        run: |
          echo "REACT_APP_API_URL=https://${{ steps.get-alb-dns.outputs.ALB_DNS }}/api" > .env.production
          cat .env.production
      
      - name: Zainstaluj zale≈ºno≈õci
        working-directory: ./frontend
        run: npm ci
      
      - name: Buduj aplikacjƒô React
        working-directory: ./frontend
        run: npm run build
      
      - name: Sprawd≈∫ czy build siƒô uda≈Ç
        working-directory: ./frontend
        run: |
          test -d build && echo "‚úÖ Build successful!" || exit 1
          echo "Build size: $(du -sh build | cut -f1)"
      
      - name: Sprawd≈∫ czy S3 bucket istnieje
        run: |
          if ! aws s3 ls "s3://${{ env.S3_BUCKET_FRONTEND }}" 2>&1 | grep -q 'NoSuchBucket'; then
            echo "‚úÖ Bucket exists"
          else
            echo "‚ö†Ô∏è  Bucket doesn't exist, creating..."
            aws s3 mb "s3://${{ env.S3_BUCKET_FRONTEND }}" --region ${{ env.AWS_REGION }}
            aws s3api put-public-access-block \
              --bucket ${{ env.S3_BUCKET_FRONTEND }} \
              --public-access-block-configuration \
              "BlockPublicAcls=true,IgnorePublicAcls=true,BlockPublicPolicy=true,RestrictPublicBuckets=true"
          fi
      
      - name: Usu≈Ñ poprzedni build z S3
        run: |
          echo "üóëÔ∏è  Deleting old build from S3..."
          aws s3 rm "s3://${{ env.S3_BUCKET_FRONTEND }}/latest/" --recursive || echo "No old build to delete"
      
      - name: Upload nowy build do S3
        run: |
          echo "üì§ Uploading new build to S3..."
          aws s3 sync frontend/build/ "s3://${{ env.S3_BUCKET_FRONTEND }}/latest/" \
            --delete \
            --region ${{ env.AWS_REGION }} \
            --exclude ".DS_Store" \
            --exclude "*.map"
          echo "‚úÖ Upload completed!"
      
      - name: Utw√≥rz backup (opcjonalne)
        run: |
          TIMESTAMP=$(date +%Y%m%d_%H%M%S)
          aws s3 sync "s3://${{ env.S3_BUCKET_FRONTEND }}/latest/" "s3://${{ env.S3_BUCKET_FRONTEND }}/backups/$TIMESTAMP/" --region ${{ env.AWS_REGION }} || echo "Backup skipped"
          echo "‚úÖ Backup created: s3://${{ env.S3_BUCKET_FRONTEND }}/backups/$TIMESTAMP/"

  # ============================================
  # UPDATE LAUNCH TEMPLATE (je≈õli potrzeba)
  # ============================================
  update-launch-template:
    name: Update Launch Template
    runs-on: ubuntu-latest
    needs: [build-and-push-backend, build-and-upload-frontend]
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    
    steps:
      - name: Pobierz kod
        uses: actions/checkout@v3
      
      - name: Konfiguruj AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}
      
      - name: Pobierz Account ID i ECR URI
        id: get-ecr-info
        run: |
          ACCOUNT_ID=$(aws sts get-caller-identity --query Account --output text)
          ECR_URI="${ACCOUNT_ID}.dkr.ecr.${AWS_REGION}.amazonaws.com/${{ env.ECR_REPOSITORY_BACKEND }}"
          echo "ECR_URI=$ECR_URI" >> $GITHUB_OUTPUT
          echo "ECR URI: $ECR_URI"
      
      - name: Pobierz najnowszƒÖ wersjƒô Launch Template
        id: get-lt
        run: |
          LATEST_VERSION=$(aws ec2 describe-launch-template-versions \
            --launch-template-name ${{ env.LAUNCH_TEMPLATE_NAME }} \
            --query 'LaunchTemplateVersions[0].VersionNumber' \
            --output text)
          echo "LATEST_VERSION=$LATEST_VERSION" >> $GITHUB_OUTPUT
          echo "Latest Launch Template version: $LATEST_VERSION"
      
      - name: Pobierz user-data z obecnej wersji
        id: get-user-data
        run: |
          USER_DATA=$(aws ec2 describe-launch-template-versions \
            --launch-template-name ${{ env.LAUNCH_TEMPLATE_NAME }} \
            --versions ${{ steps.get-lt.outputs.LATEST_VERSION }} \
            --query 'LaunchTemplateVersions[0].LaunchTemplateData.UserData' \
            --output text | base64 -d)
          echo "$USER_DATA" > /tmp/current-user-data.sh
          echo "Current user-data retrieved"
      
      - name: Aktualizuj user-data z nowym ECR URI
        run: |
          sed -i "s|ECR_URI_PLACEHOLDER|${{ steps.get-ecr-info.outputs.ECR_URI }}|g" /tmp/current-user-data.sh
          sed -i "s|AWS_ACCOUNT_ID_PLACEHOLDER|$(aws sts get-caller-identity --query Account --output text)|g" /tmp/current-user-data.sh
          # Je≈õli S3 bucket siƒô zmieni≈Ç, zaktualizuj te≈º to
          sed -i "s|FRONTEND_BUCKET_PLACEHOLDER|${{ env.S3_BUCKET_FRONTEND }}|g" /tmp/current-user-data.sh || true
      
      - name: Utw√≥rz nowƒÖ wersjƒô Launch Template
        run: |
          USER_DATA_B64=$(base64 -w 0 < /tmp/current-user-data.sh)
          NEW_VERSION=$(aws ec2 create-launch-template-version \
            --launch-template-name ${{ env.LAUNCH_TEMPLATE_NAME }} \
            --source-version ${{ steps.get-lt.outputs.LATEST_VERSION }} \
            --launch-template-data "UserData=$USER_DATA_B64" \
            --query 'LaunchTemplateVersion.VersionNumber' \
            --output text)
          echo "‚úÖ New Launch Template version created: $NEW_VERSION"

  # ============================================
  # DEPLOY - RESTART ASG
  # ============================================
  deploy:
    name: Deploy to EC2 (ASG Instance Refresh)
    runs-on: ubuntu-latest
    needs: [build-and-push-backend, build-and-upload-frontend, update-launch-template]
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    
    steps:
      - name: Konfiguruj AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}
      
      - name: Sprawd≈∫ czy Instance Refresh ju≈º dzia≈Ça
        id: check-refresh
        run: |
          REFRESH_STATUS=$(aws autoscaling describe-instance-refreshes \
            --auto-scaling-group-name ${{ env.ASG_NAME }} \
            --query 'InstanceRefreshes[0].Status' \
            --output text 2>/dev/null || echo "None")
          echo "Current refresh status: $REFRESH_STATUS"
          if [ "$REFRESH_STATUS" = "InProgress" ]; then
            echo "‚ö†Ô∏è  Instance refresh already in progress, waiting..."
            exit 0
          fi
      
      - name: Uruchom Instance Refresh
        run: |
          echo "üöÄ Starting instance refresh..."
          aws autoscaling start-instance-refresh \
            --auto-scaling-group-name ${{ env.ASG_NAME }} \
            --preferences '{
              "MinHealthyPercentage": 50,
              "InstanceWarmup": 60,
              "SkipMatching": false,
              "ScaleInProtectedInstances": "Ignore",
              "StandbyInstances": "Terminate"
            }' || echo "Instance refresh may already be in progress"
      
      - name: Czekaj na rozpoczƒôcie refresh
        run: |
          echo "‚è≥ Waiting for instance refresh to start..."
          sleep 30
      
      - name: Status deploymentu
        run: |
          echo "‚úÖ Deployment initiated!"
          echo "Backend image: ${{ needs.build-and-push-backend.outputs.IMAGE_URI || 'N/A' }}"
          echo "Frontend S3: s3://${{ env.S3_BUCKET_FRONTEND }}/latest/"
          echo "ASG: ${{ env.ASG_NAME }}"
          echo ""
          echo "Sprawd≈∫ status w AWS Console:"
          echo "  - EC2 ‚Üí Auto Scaling Groups ‚Üí ${{ env.ASG_NAME }} ‚Üí Activity tab"
          echo "  - EC2 ‚Üí Auto Scaling Groups ‚Üí ${{ env.ASG_NAME }} ‚Üí Instance refresh tab"

  # ============================================
  # NOTYFIKACJE (opcjonalne)
  # ============================================
  notify:
    name: Deployment Status
    runs-on: ubuntu-latest
    needs: [test-backend, test-frontend, build-and-push-backend, build-and-upload-frontend, deploy]
    if: always() && github.event_name == 'push' && github.ref == 'refs/heads/main'
    
    steps:
      - name: Deployment status
        run: |
          if [ "${{ needs.deploy.result }}" == "success" ]; then
            echo "‚úÖ Deployment successful!"
            echo "Backend: ${{ needs.build-and-push-backend.outputs.IMAGE_URI || 'N/A' }}"
            echo "Frontend: s3://${{ env.S3_BUCKET_FRONTEND }}/latest/"
          else
            echo "‚ùå Deployment failed!"
            exit 1
          fi


