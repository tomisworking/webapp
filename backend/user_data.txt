#!/bin/bash
set -e

# Logging
exec > >(tee /var/log/user-data.log)
exec 2>&1

echo "===== Forum EC2 Setup Started ====="
echo "Timestamp: $(date)"

# Update system
echo "Updating system packages..."
yum update -y

# Install Docker
echo "Installing Docker..."
yum install -y docker
systemctl start docker
systemctl enable docker
usermod -a -G docker ec2-user

# Install AWS CLI v2 (if not present)
if ! command -v aws &> /dev/null; then
    echo "Installing AWS CLI..."
    curl "https://awscli.amazonaws.com/awscli-exe-linux-x86_64.zip" -o "/tmp/awscliv2.zip"
    cd /tmp
    unzip awscliv2.zip
    ./aws/install
fi

# Install Nginx
echo "Installing Nginx..."
yum install -y nginx
systemctl enable nginx


# Setup SSL certificates from Parameter Store
echo "Setting up SSL certificates..."
REGION="us-east-1"
mkdir -p /etc/ssl/certs /etc/ssl/private
chmod 755 /etc/ssl/certs
chmod 700 /etc/ssl/private

# Download Cloudflare Origin Certificate from Parameter Store
aws ssm get-parameter --name "/forum/SSL_CERT" --with-decryption --query "Parameter.Value" --output text --region $REGION > /etc/ssl/certs/cloudflare-origin.pem
aws ssm get-parameter --name "/forum/SSL_KEY" --with-decryption --query "Parameter.Value" --output text --region $REGION > /etc/ssl/private/cloudflare-origin-key.pem

# Set proper permissions
chmod 644 /etc/ssl/certs/cloudflare-origin.pem
chmod 600 /etc/ssl/private/cloudflare-origin-key.pem

echo "SSL certificates installed successfully"

# Get configuration from Parameter Store
echo "Fetching configuration from Parameter Store..."
SECRET_KEY=$(aws ssm get-parameter --name "/forum/SECRET_KEY" --with-decryption --query "Parameter.Value" --output text --region $REGION)
DATABASE_URL=$(aws ssm get-parameter --name "/forum/DATABASE_URL" --with-decryption --query "Parameter.Value" --output text --region $REGION)
ALLOWED_HOSTS=$(aws ssm get-parameter --name "/forum/ALLOWED_HOSTS" --query "Parameter.Value" --output text --region $REGION)
FRONTEND_BUCKET=$(aws ssm get-parameter --name "/forum/FRONTEND_BUCKET" --query "Parameter.Value" --output text --region $REGION)

# ECR Repository URI - TWOJE WARTOŚCI JUŻ WYPEŁNIONE ✅
ECR_URI="311603531332.dkr.ecr.us-east-1.amazonaws.com/forum-backend"

# Login to ECR
echo "Logging into ECR..."
aws ecr get-login-password --region $REGION | docker login --username AWS --password-stdin ${ECR_URI%%/*}

# Pull Django Docker image
echo "Pulling Django Docker image..."
docker pull ${ECR_URI}:latest

# Run Django container
echo "Starting Django container..."

# Extract ALB DNS from ALLOWED_HOSTS (first element before comma)
ALB_DNS=$(echo ${ALLOWED_HOSTS} | cut -d',' -f1)

# CORS_ALLOWED_ORIGINS: Include both ALB DNS and domain (for Cloudflare with/without proxy)
# This allows requests from both direct ALB access and domain access
# Include both HTTP and HTTPS versions (Cloudflare proxy automatically uses HTTPS)
CORS_ORIGINS="http://${ALB_DNS},http://kongoapp.pl,http://www.kongoapp.pl,https://kongoapp.pl,https://www.kongoapp.pl"

docker run -d \
  --name forum-backend \
  --restart always \
  -p 8000:8000 \
  -e SECRET_KEY="$SECRET_KEY" \
  -e DATABASE_URL="$DATABASE_URL" \
  -e ALLOWED_HOSTS="$ALLOWED_HOSTS" \
  -e DEBUG="False" \
  -e CORS_ALLOWED_ORIGINS="$CORS_ORIGINS" \
  -e COOKIE_SECURE="False" \
  ${ECR_URI}:latest

# Wait for Django to start
echo "Waiting for Django to start..."
sleep 10

# Download React build from S3
echo "Downloading React frontend from S3..."
mkdir -p /var/www/frontend
aws s3 sync s3://${FRONTEND_BUCKET}/latest/ /var/www/frontend/ --delete

# Configure Nginx
echo "Configuring Nginx..."
cat > /etc/nginx/conf.d/forum.conf << 'EOF_NGINX'
upstream django {
    server 127.0.0.1:8000;
}

# HTTPS server
server {
    listen 443 ssl default_server;
    http2 on;
    server_name kongoapp.pl www.kongoapp.pl;

    # SSL configuration - Cloudflare Origin Certificate
    ssl_certificate /etc/ssl/certs/cloudflare-origin.pem;
    ssl_certificate_key /etc/ssl/private/cloudflare-origin-key.pem;
    
    # SSL protocols and ciphers
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_ciphers 'ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384';
    ssl_prefer_server_ciphers off;
    
    # SSL session cache
    ssl_session_cache shared:SSL:10m;
    ssl_session_timeout 10m;
    
    root /var/www/frontend;
    index index.html;

    client_max_body_size 10M;
    client_body_buffer_size 128k;

    # Health check for ALB
    location /health {
        access_log off;
        return 200 "healthy\n";
        add_header Content-Type text/plain;
    }

    # Django health check
    location /api/health/ {
        proxy_pass http://django;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto https;
        proxy_connect_timeout 10s;
        proxy_read_timeout 30s;
    }

    # API requests → Django
    location /api/ {
        proxy_pass http://django;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto https;
        proxy_connect_timeout 60s;
        proxy_send_timeout 60s;
        proxy_read_timeout 60s;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
    }

    # Django admin
    location /admin {
        proxy_pass http://django;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto https;
    }

    # Django admin static files (must be before /static/)
    location /static/admin/ {
        proxy_pass http://django;
    }

    # React static files (JS, CSS, etc.)
    location /static/ {
        alias /var/www/frontend/static/;
        expires 1y;
        add_header Cache-Control "public, immutable";
        try_files $uri =404;
    }

    # Django media files
    location /media/ {
        proxy_pass http://django;
        expires 7d;
        add_header Cache-Control "public";
    }

    # React frontend
    location / {
        try_files $uri $uri/ /index.html;
        expires 1h;
        add_header Cache-Control "public, must-revalidate";
    }

    # React static assets
    location ~* \.(js|css|png|jpg|jpeg|gif|ico|svg|woff|woff2|ttf|eot)$ {
        expires 1y;
        add_header Cache-Control "public, immutable";
        try_files $uri =404;
    }

    # Security headers - OWASP ZAP compliance
    add_header X-Content-Type-Options "nosniff" always;
    add_header X-Frame-Options "DENY" always;
    add_header X-XSS-Protection "1; mode=block" always;
    add_header Referrer-Policy "strict-origin-when-cross-origin" always;
    add_header Permissions-Policy "geolocation=(), microphone=(), camera=(), payment=(), usb=(), magnetometer=(), gyroscope=(), accelerometer=()" always;
    
    # Content Security Policy - prevents XSS and clickjacking
    add_header Content-Security-Policy "default-src 'self'; script-src 'self' 'unsafe-inline'; style-src 'self' 'unsafe-inline'; img-src 'self' data: https:; font-src 'self' data:; connect-src 'self' https://kongoapp.pl; frame-ancestors 'none'; base-uri 'self'; form-action 'self'; upgrade-insecure-requests;" always;

    location ~ /\. {
        deny all;
        access_log off;
        log_not_found off;
    }
}

# HTTP server - health check and serve content (ALB terminates SSL)
server {
    listen 80 default_server;
    server_name kongoapp.pl www.kongoapp.pl _;

    root /var/www/frontend;
    index index.html;

    # Health check for ALB
    location /health {
        access_log off;
        return 200 "healthy\n";
        add_header Content-Type text/plain;
    }

    # Django API
    location /api/ {
        proxy_pass http://django;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $http_x_forwarded_proto;
    }

    # Django admin
    location /admin {
        proxy_pass http://django;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $http_x_forwarded_proto;
    }

    # Django admin static files (must be before /static/)
    location /static/admin/ {
        proxy_pass http://django;
    }

    # React static files (JS, CSS, etc.)
    location /static/ {
        alias /var/www/frontend/static/;
        expires 1y;
        add_header Cache-Control "public, immutable";
        try_files $uri =404;
    }

    # Django media
    location /media/ {
        proxy_pass http://django;
    }

    # React frontend
    location / {
        try_files $uri $uri/ /index.html;
    }
}
EOF_NGINX

# Remove default Nginx config and server block
rm -f /etc/nginx/conf.d/default.conf

# Create clean nginx.conf without default server block
cat > /etc/nginx/nginx.conf << 'EOF_NGINX_MAIN'
user nginx;
worker_processes auto;
error_log /var/log/nginx/error.log;
pid /run/nginx.pid;

include /usr/share/nginx/modules/*.conf;

events {
    worker_connections 1024;
}

http {
    log_format  main  '$remote_addr - $remote_user [$time_local] "$request" '
                      '$status $body_bytes_sent "$http_referer" '
                      '"$http_user_agent" "$http_x_forwarded_for"';

    access_log  /var/log/nginx/access.log  main;

    sendfile            on;
    tcp_nopush          on;
    tcp_nodelay         on;
    keepalive_timeout   65;
    types_hash_max_size 4096;

    include             /etc/nginx/mime.types;
    default_type        application/octet-stream;

    # Load site configs
    include /etc/nginx/conf.d/*.conf;
}
EOF_NGINX_MAIN

# Start Nginx
echo "Starting Nginx..."
systemctl restart nginx

echo "===== Setup Complete ====="
echo "Services status:"
echo "  - Docker: $(systemctl is-active docker)"
echo "  - Nginx: $(systemctl is-active nginx)"
echo "  - Django container: $(docker ps --filter name=forum-backend --format '{{.Status}}')"
echo ""
echo "Logs:"
echo "  - This script: /var/log/user-data.log"
echo "  - Nginx: /var/log/nginx/error.log"
echo "  - Django: docker logs forum-backend"
echo ""
echo "Deployment timestamp: $(date)"